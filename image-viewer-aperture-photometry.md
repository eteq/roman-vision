# Image Viewer Science Case: Do aperture photometry from the platform on a specific Roman image subset

This case follows  *conceptually* from Entry Point 2 in the [image viewer base case](image-viewer-base.md), but is not the same science case nor the same characters.  But it starts from the assumption have figured out already how to get to the image viewer on the platform following a workflow something like that.

Luke is an undergraduate researcher who is working with a much more experienced scientist, Obi-Wan.  They want to use Roman imaging to try to study stars in a star cluster in the LMC.  Luke is very much a natural at Python programming, already sometimes doing better than Obi-Wan in certain tech skills (like how to make good use of the Jedi static code analysis tool...). So he is quickly able to get to the point of starting up the Roman Science Platform, and pulling up the star cluster they are studying in the image viewer.  He uses the catalog querying tools (detailed in the "database-access" related sections) to get a photometry table for the stars in the cluster.  When he makes a color-magnituide diagram, though, Obi-Wan looks at it and says "I feel a great disturbance in this plot." They identify some sources that seem to be in very odd places in the CMD by eye, and then plot markers in the image viewer for just those objects in the image viewer.  With those locations marked and after playing with the stretch a bit, they see that there is a large-area but wavy-structured nebulosity that is clearly spoiling the photometry that is good for most areas .  They realize they will need to do a by-hand removal of that feature, and then re-do the photometry.  Fortunately, for this cluster, the stars of interest are not particularly crowded, so they can use aperture photometry.

First they need to remove the background structure.  Fortunately, it has a polynomial-like profile, so the standard tools in `photutils` to do background subtraction can be used here.  Luke finds the relevant mosaic images for the cluster using `astroquery.mast` (level 3 in JWST language, which is either 4 or 2 in Roman?), and loads that into imviz. It's near-instantaneous because the data are in the platform so no download is needed.  They use imviz's API to pull out the data arrays, and run the standard photutils subtraction steps, and creating background-subtracted images.  They add those back into imviz to allow blinking between the subtracted and un-subtracted image. It requires a few tries to get the initial parameters right for the fit, but once they have done this. The get a much cleaner background.

To make sure this is all working, Luke sees there is a photometry plugin for imviz. He finds an example from the stars that were problematic before, and uses the plugin to try to do aperture photometry on that one star.  Intially it doesn't work well, but Obi-Wan notices he hasn't checked a box to force the center coordinates to match the original catalog "Use the force, Luke", he says, and after this the photometry looks much better.  They then by eye compare where the star would be on the CMD with the photometry including the background subtraction and see that it indeed now ends up where it should be, rather than the odd outlier status it had before.  This gives them the confidence that they've got the solution to the original problem.

Following this, they then run the standard `photutils` aperture photometry machinery on the full image, using the original catalog star positions as the initial parameters.  The CMD now looks much better, and they go on to detect several new examples of the rare type of star they were looking for, giving Luke a clear path to write a paper.  This gives Luke the chance he's been waiting for to apply for graduate school and try to leave the small college town of Tatooine that he's been in his whole life.


## Stretch goal: large-scale processing

(This case depends on some other developments in the Roman Science Platform that may or may not happen, so is treated as a stretch goal.)

Having worked out the method in this one star cluster, Obi-Wan and Luke realize they want to repeat over all the clusters in the LMC. They know neither of them have the expertise for large-scale computation though so they're not sure what to do.  Fortunately, when they go out to the campus coffee shop for a break (which is playing some [odd weird background music, by the way](https://www.youtube.com/watch?v=xA8-6X8aR3o)), they hear that there's someone visiting from a high performance computing center, named Han. Han turns out to have some knowledge of astronomy - he tells them he's "Done the Kessel Run in 12 parsecs", referring to a very high-resolution data reduction using the method of Kessel et al. to parallelize the computation.

Han agrees to help them out with this problem (although he demands an advance agreement that Obi-Wan's grant covers his time). He starts from Luke's notebooks, which are easily shared with him by adding him to Luke and Obi-Wan's group on the Roman Science Platform, along with a list of coordinates they give him (that file is, of course, ``alderaan.ecsv``).  He spends some time looking through the Roman Platform's capabilities and comes across the batch run capability. He realizes that what he really needs to do is to make a hundred or so copies of Luke's notebook, which is easy to do with existing software like (papermill)[https://papermill.readthedocs.io/en/latest/usage-parameterize.html], but that he needs to run them on the Roman Science Platform to take advantage of the data locality.  He uses the batch interface to simply run papermill on all of the notebooks, and goes off to watch his collaborators play an (odd game)[https://www.youtube.com/watch?v=rN0T5tyJlo8] while they wait. Once the computation is done they all go and look at the results.  Some of it looks great, but they encounter some unexpected problems... See (the PSF photometry case)[image-viewer-psf-photometry.md] for the next episode.

## Notes

I don't know if there's actually a full-LMC survey planned for Roman, nor am I confident in the details of how crowded LMC clusters are.  But don't worry about that detail - this is an illuistrative science case, not meant to say "this particular science should be done in that particular way".

Also, implicit in this case is 1) there's an easy way to get mosaic(s) that cover a given region, and 2) if you load it, imviz can handle such a large mosaic. I highlight these because they are not really specifically highlighted in the science  case, but are absolutely needed for this science case to be doable.